#!/bin/bash

set -e
set -u

ORIG_SCRIPT=$( readlink -f "$0" )
SCRIPT_DIR=$( dirname "${ORIG_SCRIPT}" )
RC_FILE="${SCRIPT_DIR}/debbuildtools.rc"

if [[ ! -f "${RC_FILE}" ]] ; then
    echo "File '${RC_FILE}' not found." >&2
    exit 5
fi

if [[ ! -r "${RC_FILE}" ]] ; then
    echo "File '${RC_FILE}' not readable." >&2
    exit 5
fi

. "${RC_FILE}"

set_workdir

for distro in "${BINARY_DISTROS[@]}" ; do
    echo
    echo "Checking for distro '${distro}' ..."
    bin_dir="pkgs-${distro}"
    find * -maxdepth 0 -type f -iname "${BIN_PKG_GLOB[${distro}]}" -print0 | \
        xargs --null --max-lines --no-run-if-empty --replace bash -c " \
            if [[ ! -d \"${bin_dir}\" ]] ; then \
                mkdir --verbose -p \"${bin_dir}\" ;
            fi ; \
            mv --verbose \"{}\" \"${bin_dir}\"
        "
done

echo
echo "Checking for sources ..."
find * -maxdepth 0 \( -iname "*.build" -o -iname "*.changes" -o -iname "*.dsc" -o -iname "*.tar.*" \) -print0 | \
    xargs --null --max-lines --no-run-if-empty --replace bash -c " \
        if [[ -f \"{}\" ]] ; then
            if [[ ! -d \"${SRC_DIR}\" ]] ; then \
                mkdir --verbose -p \"${SRC_DIR}\" ;
            fi ; \
            mv --verbose \"{}\" \"${SRC_DIR}\";
        else
            echo \"'{}' is not a regular file.\" >&2 ;
        fi
    "

echo
echo "Checking for orphaned symlinks ..."
find * -maxdepth 0 -iname "*.build" -type l -print0 | xargs --null --no-run-if-empty rm --verbose

# vim: ts=4 et
